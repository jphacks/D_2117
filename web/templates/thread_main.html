{% extends "common.html" %}
{% block title %}タイムライン{% endblock %}
{% block header %}タイムライン{% endblock %}
{% block main %}
  {% macro render_error(field) %}
    <ul class=errors>
      {% for error in field.errors %}
        <font color='red'>{{ error }}</font>
      {% endfor %}
    </ul>
  {% endmacro %}
      
  <!--返信ページ-->
  {% if reply_id != 0 %}
    <div class='row'>

      <!--返信元の投稿-->
      <div class='col-md-6'>
        <h3 class="pb-1 font-italic border-bottom">{{ nicknamelist.filter_by(id=threadtop.user_id).first().user_nickname }} さんの投稿</h3>
        <div class='mx-0'>
          <div class="card h-100 p-3">
            <img src="/static/images/{{threadtop.img_source}}.jpg" class="rounded img-fluid">
            <div class="card-body">
              <p class="card-text" style="white-space:pre-wrap;">{{threadtop.message}}</p>
              <p class="card-text"><small class="text-muted">{{threadtop.update.strftime("%y/%m/%d %H:%M")}}</small></p>
            </div>
          </div>
        </div>
      </div>

      <div class='col-md-6'>
        <div class='mx-0'>
          <!--返信用フォーム-->
          <h3 class="pb-1 font-italic border-bottom">返信する</h3>

          <!--返信にはログインが必要-->
          {% if current_user.is_authenticated %}
            <form name="threadsubmissionform" method="post" enctype="multipart/form-data">
              {{ form.csrf_token }}
              <div class="mb-3">
                <label for="exampleFormControlTextarea1" class="form-label">メッセージ</label>
                <textarea class="form-control" name="message" rows="3" maxlength="400" required></textarea>
              </div>
                <div class='row'>
                  <div class='col'>
                    <div class="d-grid">
                      <button type="submit" name="sub" class="btn btn-outline-primary" color=#f5deb3>送信</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          {% else %}
            
            <form name="threadsubmissionform" method="post" enctype="multipart/form-data">
              {{ form.csrf_token }}
              <div class="mb-3">
                <label for="exampleFormControlTextarea1" class="form-label">
                  メッセージ (返信するには<a href="http://date.ddns.net:7777/login" class="link-primary">ログイン</a>が必要です。)
                </label>
                <textarea class="form-control" name="message" rows="3" maxlength="400" required disabled></textarea>
              </div>
                <div class='row'>
                  <div class='col'>
                    <div class="d-grid">
                      <button type="submit" name="sub" class="btn btn-outline-primary" color=#f5deb3 disabled>送信</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          {% endif %}


        <!--返信一覧-->
        <h3 class="pt-4 pb-1 font-italic border-bottom">みんなの反応</h3>
        {% for thread in threadlist %}
            {% if thread.img_source != None %}
              <img src="/static/images/{{thread.img_source}}.jpg" class='rounded img-fluid'>
            {% endif %}
            {{ nicknamelist.filter_by(id=thread.user_id).first().user_nickname }} さん
            <div class="card-body">
              <div style="white-space:pre-wrap;">{{thread.message}}</div><br>
              {% if thread.img_source != None %}
                <a href="/thread/{{thread.thread_id}}">返信する</a>
              {% endif %}
            </div>
        {% endfor %}

      </div>

    </div>
  {% endif %}

  {% if current_user.is_authenticated %}
    
    {% if reply_id == 0 %}
      <div class='row'>
        <h3 class="pb-2 font-italic border-bottom">新規投稿</h3>
      </div>
    {% endif %}
    
    <div class="row pb-4">
      <form name="threadsubmissionform" method="post" enctype="multipart/form-data">
        {{ form.csrf_token }}
        {% if reply_id == 0 %}
          <div class="mb-3">
            <label for="exampleFormControlTextarea1" class="form-label">メッセージ</label>
            <textarea class="form-control" name="message" rows="3" maxlength="400" required></textarea>
          </div>
          <div class='row'>
            <div class='col-md-5'>
              <div class="mb-3">
                <label for="formFile" class="form-label">ペットの画像</label>
                <input class="form-control" type="file" name="img" accept="image/*" required>
              </div>
            </div>
            <div class='col-md-5'>
              <div class="mb-3">
                <label for="exampleFormControlTextarea1" class="form-label">ペットの名前 (※先に<a href="/petInfo">ペットを登録</a>してください)</label>
                <select class="form-select" aria-label="Default select example" name="pet_id" required>
                  <option selected value="" disabled>ペットの名前を選択</option>
                  {% for p_id in form.pet_id %}
                    {{p_id}}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class='col-md-2'>
              <div class="d-grid">
                <label for="exampleFormControlTextarea1" class="form-label">&nbsp;</label>
                <button type="submit" name="sub" class="btn btn-outline-primary">送信</button>
              </div>
            </div>
          </div>
        {% endif %}
      </form>
    </div>
  {% endif %}

  {% if reply_id == 0 %}
    <div class='row'>
      <h3 class="pt-4 pb-1 font-italic border-bottom">
        みんなの投稿
      </h3>
    </div>
    <!-- 投稿一覧を表示　-->
    {% include "posts.html"%}

  {% endif %}


{% endblock %}